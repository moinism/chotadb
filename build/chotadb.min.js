/*! 
 chotadb.js v0.3.0 generated on 05-01-2016 14:43:54 - (c) 2016 Moin Uddin <me@moin.im> (https://moin.im) 
 Available under MIT license. - https://chotadb.moin.im 
*/
!function(a){"use strict";function b(a,b){return"ChotaDB"+(b?v+b:"")+v+a}function c(a,b){return t[a]=b,w}function d(a,b){"function"==typeof t[a]&&t[a](b)}function e(a,b){return a==b?!0:"string"==typeof a&&"string"==typeof b?a.toLowerCase()==b.toLowerCase():"string"==typeof a&&Array.isArray(b)?b.indexOf(a)>-1:Array.isArray(a)&&!Array.isArray(b)?a.indexOf(b)>-1:Array.isArray(a)&&Array.isArray(b)?b.containsArray(a):!1}function f(a){return Array.isArray(a)||"string"==typeof a?a.length:"object"==typeof a?Object.keys(a).length:void 0}function g(a){return void 0!==s[a]}function h(a){return g(a)?new p(a):(s[a]={total:0,nextKey:1},z(b(a,"Data"),[]),j(),d("created",{collection:a}),w[a]=new p(a))}function i(a){return g(a)?(delete s[a],delete w[a],A(b(a,"Data")),j(),d("dropped",{collection:a}),w):(d("error",{reason:"Collection does not exists."}),w)}function j(){return s=z(b("Meta"),s)}function k(a,b){var c=[],d=[];return a.forEach(function(a){void 0===c[a[b]]&&(c[a[b]]=1,d.push(a))}),d}function l(a,b){if(b){if(1===b||-1===b)b={key:"_id",type:b};else if("object"==typeof b){var c=Object.keys(b)[0];b={key:c,type:b[c]}}}else b={key:"_id",type:1};return a.sort(function(a,c){return a[b.key]<c[b.key]?-1*b.type:a[b.key]>c[b.key]?1*b.type:0})}function m(a,b){return b&&"object"==typeof b&&null!==b?(b.sort&&(a=l(a,b.sort)),b.unique&&(a=k(a,b.unique)),b.skip&&b.skip>0&&b.limit&&b.limit>0&&(b.limit+=b.skip),a.slice(b.skip,b.limit)):a}function n(a){s=a,o(function(a){w[a]=this})}function o(a){for(var b in s)a.call(new p(b),b)}function p(a){function c(c){q=z(b(a,"Data"),q),c&&(t=q)}function g(a,b){q.forEach(function(c,d){c._id===a&&b(c,d)})}function h(a,b,c){return a&&"function"==typeof a?(a.call(null,b),c):b}function i(a,b){return g(a._id,function(c,d){for(var e in b)"_id"!=e&&(a[e]=b[e]);q[d]=a}),a}function n(a){g(a._id,function(a,b){q.splice(b,1),p.total--})}function o(b){var e=t[b],f={get data(){return e},update:function(b){return e=i(e,b),c(),d("updated",{collection:a,change:b,affected:[e._id]}),this},remove:function(){return n(e),s[a]=p,j(),c(!0),d("removed",{collection:a,removed:[e._id]}),this}};return f}var p=s[a],q=y(b(a,"Data")),r=!1,t=q,u={get data(){return y(b(a,"Data"))},get info(){var b=p;return b.name=a,b},get all(){return t=q,this},get keys(){},insert:function(b){return b._id=p.nextKey++,q.push(b),p.total++,s[a]=p,j(),c(!0),d("inserted",{collection:a,data:b}),this},bulkInsert:function(a){return Array.isArray(a)?a.forEach(this.insert):d("error",{reason:"bulkInsert expects an array, '"+typeof a+"' was given instead."}),this},replicateTo:function(a){return a.bulkInsert(this.all.get()),this},replicateFrom:function(a){return this.bulkInsert(a.all.get()),this},or:function(a,b){var c=t;return t=q,this.find(a,b)&&(t=c.concat(t)),this},and:function(a,b){return r=!0,this.find(a,b),r=!1,this},find:function(a,b){if(r||(t=q),b=b||{},!a||null===a||null!==a&&"object"==typeof a&&0===f(a))return t=m(q,b),this;var c=t;return t=[],c.forEach(function(b){for(var c in a)void 0===b[c]||a[c]!==1/0&&!e(a[c],b[c])||t.push(b)}),t=m(t,b),this},update:function(b){if(b&&"object"==typeof b){var e=[];return t.forEach(function(a,c){t[c]=i(a,b),e.push(a._id)}),c(),d("updated",{collection:a,affected:e,change:b}),this}},remove:function(){var b=[];return t.forEach(function(a){n(a),b.push(a._id)}),s[a]=p,j(),c(!0),d("removed",{collection:a,removed:b}),this},findById:function(a){return this.find({_id:a},{limit:1})},findOne:function(a){return this.find(a,{limit:1})},each:function(a){return t.forEach(function(b,c){a.call(new o(c),b)}),this},filter:function(a){var b=t;return t=[],b.forEach(function(b){a.call(this,b)===!0&&t.push(b)}),this},get first(){return t=[t[0]],this},get last(){return t=[t[t.length-1]],this},sort:function(a){return t=l(t,a),this},unique:function(a){return t=k(t,a),this},skip:function(a){return t=t.slice(a),this},limit:function(a){return t=t.slice(0,a),this},count:function(a){return h(a,f(t),this)},then:function(a){return a&&"function"==typeof a?(a.call(this,t),this):this},get:function(a){return h(a,t,this)}};return u.where=u.find,u}function q(a){u=a,y=function(a){return JSON.parse(u.getItem(a))},z=function(a,b){var c=JSON.stringify(b);return u.setItem(a,c),JSON.parse(c)},A=function(a){u.removeItem(a)},r()}function r(){n(void 0===u.getItem(b("Meta"))?z(b("Meta"),{}):y(b("Meta")))}var s={},t=[],u=null,v="/",w={ALL:1/0,ANY:1/0,SORT:{ASC:1,DSC:-1},create:h,drop:i,each:o,hasCollection:g,on:c},x=function(a){return a=a||{},w};Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null===this)throw new TypeError("this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(arguments.length>1&&(c=b),d=0;f>d;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}}),Array.prototype.containsArray=function(a){var b=null,c=null;return arguments[1]?(b=arguments[1],c=arguments[2]):(b=0,c=0,this.sort(),a.sort()),b==a.length||(c=this.indexOf(a[b],c))>-1&&this.containsArray(a,++b,++c)};var y,z,A=null;if("object"==typeof module&&module&&"object"==typeof module.exports){v="-";var B=require("node-persist");B.initSync({dir:process.env.PWD+"/ChotaData",stringify:function(a){return a},parse:function(a){return a}}),q(B),module.exports=x,B=null}else a.chrome&&chrome.runtime&&chrome.runtime.id?q():a.localStorage&&(q(a.localStorage),a.ChotaDB=x,"function"==typeof define&&define.amd&&define("ChotaDB",[],function(){return x}))}(this);