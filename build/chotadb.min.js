/*
  chotadb.js v0.3.3 file generated on Tue Jan 26 2016 18:42:18 
  (c) 2016 Moin Uddin <me@moin.im> (https://moin.im) 
  Available under MIT license - https://chotadb.moin.im 
*/

!function(a){"use strict";function b(a,b){return"ChotaDB"+(b?w+b:"")+w+a}function c(a,b){return x[a].push(b),C}function d(a,b){x[a].forEach(function(a){a(b)})}function e(a,b){return a==b?!0:"string"==typeof a?"string"==typeof b&&a.toLowerCase()==b.toLowerCase()||Array.isArray(b)&&b.indexOf(a)>-1:"object"==typeof a?void 0!==a.exec&&null!==a.exec(b)||a.$ne&&b!==a.$ne||b<a.$lt||b<=a.$lte||b>a.$gt||b>=a.$gte:Array.isArray(a)?!Array.isArray(b)&&a.indexOf(b)>-1||Array.isArray(b)&&b.containsArray(a):!1}function f(a){return Array.isArray(a)||"string"==typeof a?a.length:"object"==typeof a?Object.keys(a).length:void 0}function g(a){return void 0!==u[a]}function h(){return q(function(a){null===y(b(a,"Data"))&&k(a)}),C}function i(a){return g(a)?new r(a):(d("error",{code:2,reason:"Collection does not exists."}),C)}function j(a){return a?g(a)&&!C.hasOwnProperty(a)?new r(a):C.hasOwnProperty(a)?(d("error",{code:1,reason:"Collection cannot be created with this name."}),C):(u[a]={total:0,nextKey:1},z(b(a,"Data"),[]),l(),d("created",{collection:a}),C[a]=new r(a)):C}function k(a){return a?g(a)?(delete u[a],delete C[a],A(b(a,"Data")),l(),d("dropped",{collection:a}),C):(d("error",{code:2,reason:"Collection does not exists."}),C):C}function l(){return u=z(b("Meta"),u)}function m(a,b){var c=[],d=[];return a.forEach(function(a){void 0!==a[b]&&void 0===c[a[b]]&&(c[a[b]]=1,d.push(a))}),d}function n(a,b){if(b){if(1===b||-1===b)b={key:"_id",type:b};else if("string"==typeof b)b={key:b,type:1};else if("object"==typeof b){var c=Object.keys(b)[0];b={key:c,type:b[c]}}}else b={key:"_id",type:1};return a.sort(function(a,c){return a[b.key]<c[b.key]?-1*b.type:a[b.key]>c[b.key]?1*b.type:0})}function o(a,b){return b&&"object"==typeof b&&null!==b?((b.sort||b.orderBy)&&(a=n(a,b.sort||b.orderBy)),b.unique&&(a=m(a,b.unique)),b.skip&&b.skip>0&&b.limit&&b.limit>0&&(b.limit+=b.skip),a.slice(b.skip,b.limit)):a}function p(a){u=a,q(function(a){C[a]=this})}function q(a){if(!a)return C;for(var b in u)a.call(new r(b),b);return C}function r(a){function c(c){t=z(b(a,"Data"),t),c&&(w=t)}function g(a,b){t.forEach(function(c,d){c._id===a&&b(c,d)})}function h(a,b,c){return a&&"function"==typeof a?(a(b),c):b}function i(a,b){return g(a._id,function(c,d){for(var e in b)"_id"!==e&&(a[e]=b[e]);t[d]=a}),a}function p(a){g(a._id,function(a,b){t.splice(b,1),s.total--})}function q(b){var e={get data(){return b},get keys(){return Object.keys(b)},update:function(e){return b=i(b,e),c(),d("updated",{collection:a,change:e,affected:[b._id]}),this},increment:function(a){if(!isNaN(b[a])){var c={};c[a]=++b[a],this.update(c)}return this},decrement:function(a){if(!isNaN(b[a])){var c={};c[a]=--b[a],this.update(c)}return this},remove:function(){return p(b),u[a]=s,l(),c(!0),d("removed",{collection:a,removed:[b._id]}),this}};return e}var s=u[a],t=y(b(a,"Data")),v=!1,w=t,x={get data(){return y(b(a,"Data"))},get info(){var b=s;return b.name=a,b},get all(){return w=t,this},get keys(){var a=[];return t.forEach(function(b){Object.keys(b).forEach(function(b){a.push(b)})}),a.unique()},insert:function(b){return b._id=s.nextKey++,t.push(b),s.total++,u[a]=s,l(),c(!0),d("inserted",{collection:a,data:b}),this},bulkInsert:function(a){return Array.isArray(a)?a.forEach(this.insert):d("error",{reason:"bulkInsert expects an array, '"+typeof a+"' was given instead."}),this},replicateTo:function(a){return"string"==typeof a&&(a=new r(a)),a.bulkInsert(this.all.get()),this},replicateFrom:function(a){return"string"==typeof a&&(a=new r(a)),this.bulkInsert(a.all.get()),this},or:function(a,b){var c=w;return w=t,this.find(a,b)&&(w=c.concat(w)),this},and:function(a,b){return v=!0,this.find(a,b),v=!1,this},find:function(a,b){if(v||(w=t),b=b||{},!a||null===a||null!==a&&"object"==typeof a&&0===f(a))return w=o(t,b),this;var c=w;w=[];var d=f(a),g=0;return c.forEach(function(b){g=0;for(var c in a)void 0===b[c]||a[c]!==1/0&&!e(a[c],b[c])||g++,g==d&&w.push(b)}),w=o(w,b),this},update:function(b){if(b&&"object"==typeof b){var e=[];return w.forEach(function(a,c){w[c]=i(a,b),e.push(a._id)}),c(),d("updated",{collection:a,affected:e,change:b}),this}},remove:function(){var b=[];return w.forEach(function(a){p(a),b.push(a._id)}),u[a]=s,l(),c(!0),d("removed",{collection:a,removed:b}),this},empty:function(){return k(a),j(a)},findById:function(a){return this.find({_id:a},{limit:1})},findOne:function(a){return this.find(a,{limit:1})},each:function(a){return w.forEach(function(b,c){a.call(new q(b),b)}),this},filter:function(a){var b=w;return w=[],b.forEach(function(b){a.call(this,b)===!0&&w.push(b)}),this},get first(){return w=[w[0]],this},get last(){return w=[w[w.length-1]],this},sort:function(a){return w=n(w,a),this},unique:function(a){return w=m(w,a),this},skip:function(a){return w=w.slice(a),this},limit:function(a){return w=w.slice(0,a),this},count:function(a){return h(a,f(w),this)},then:function(a){return a&&"function"==typeof a?(a.call(this,w),this):this},get:function(a){return h(a,w,this)}};return x.where=x.find,x.orderBy=x.sort,x.groupBy=x.unique,x}function s(a){v=a,y=function(a){return B.parse(v.getItem(a))},z=function(a,b){var c=B.stringify(b);try{v.setItem(a,c)}catch(e){d("error",{code:3,reason:"Unable to store data."})}return B.parse(c)},A=function(a){v.removeItem(a)},t()}function t(){p(void 0===v.getItem(b("Meta"))?z(b("Meta"),{}):y(b("Meta")))}var u={},v=null,w="/",x={error:[],created:[],dropped:[],inserted:[],updated:[],removed:[]};Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null===this)throw new TypeError("this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(arguments.length>1&&(c=b),d=0;f>d;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}}),Array.prototype.containsArray=function(a){var b=null,c=null;return arguments[1]?(b=arguments[1],c=arguments[2]):(b=0,c=0,this.sort(),a.sort()),b===a.length||(c=this.indexOf(a[b],c))>-1&&this.containsArray(a,++b,++c)},Array.prototype.unique=function(){for(var a={},b=[],c=0,d=this.length;d>c;++c)a.hasOwnProperty(this[c])||(b.push(this[c]),a[this[c]]=1);return b};var y=null,z=null,A=null,B={parse:JSON.parse,stringify:JSON.stringify},C={ANY:1/0,SORT:{ASC:1,DSC:-1},create:j,drop:k,each:q,hasCollection:g,match:RegExp,on:c,repair:h,select:i,gt:function(a){return{$gt:a}},gte:function(a){return{$gte:a}},lt:function(a){return{$lt:a}},lte:function(a){return{$lte:a}},ne:function(a){return{$ne:a}}},D=function(a){return a=a||{},C};if("object"==typeof module&&"object"==typeof module.exports){w="-";var E=require("node-persist");E.initSync({dir:process.env.PWD+"/ChotaData",stringify:function(a){return a},parse:function(a){return a}}),s(E),module.exports=D,E=null}else a.chrome&&chrome.runtime&&void 0!==chrome.runtime.id?(s(a.localStorage),a.ChotaDB=D):a.localStorage&&(s(a.localStorage),a.ChotaDB=D,"function"==typeof define&&define.amd&&define("ChotaDB",[],function(){return D}))}(this);