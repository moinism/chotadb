/*! 
 chotadb.js v0.1.9 built on 2016-01-02 - (c) 2016 Moin Uddin <me@moin.im> (https://moin.im) 
 Available under MIT license. - https://github.com/moinism/chotadb 
*/
!function(a){"use strict";function b(a,b){return"ChotaDB"+(b?t+b:"")+t+a}function c(a,b){return r[a]=b,u}function d(a,b){"function"==typeof r[a]&&r[a](b)}function e(a,b){return a==b?!0:"string"==typeof a&&"string"==typeof b?a.toLowerCase()==b.toLowerCase():"string"==typeof a&&Array.isArray(b)?b.indexOf(a)>-1:Array.isArray(a)&&Array.isArray(b)?b.containsArray(a):!1}function f(a){return Array.isArray(a)||"string"==typeof a?a.length:"object"==typeof a?Object.keys(a).length:void 0}function g(a){return void 0!==q[a]?!0:!1}function h(a){return g(a)?new n(a):(q[a]={total:0,nextKey:1},x(b(a,"Data"),[]),j(),d("created",{collection:a}),u[a]=new n(a))}function i(a){return g(a)?(delete q[a],delete u[a],y(b(a,"Data")),j(),d("dropped",{collection:a}),u):(d("error",{reason:"Collection does not exists."}),u)}function j(){return x(b("Meta"),q)}function k(a,b){if(1===b||-1===b)b={key:"_id",type:b};else if("object"==typeof b){var c=Object.keys(b)[0];b={key:c,type:b[c]}}return a.sort(function(a,c){return a[b.key]<c[b.key]?-1*b.type:a[b.key]>c[b.key]?1*b.type:0})}function l(a,b){return b&&"object"==typeof b&&null!==b?(b.sort&&(a=k(a,b.sort)),b.skip&&b.skip>0&&b.limit&&b.limit>0&&(b.limit+=b.skip),a.slice(b.skip,b.limit)):a}function m(a){q=a;for(var b in q)u[b]=new n(b)}function n(a){function c(c){x(b(a,"Data"),h),h=w(b(a,"Data")),c&&(i=h)}var g=q[a],h=w(b(a,"Data")),i=h,m={get data(){return w(b(a,"Data"))},all:function(){return i=h,this},insert:function(b){return b._id=g.nextKey++,h.push(b),g.total++,q[a]=g,j(),c(!0),d("inserted",{collection:a,data:b}),this},bulkInsert:function(a){return Array.isArray(a)?a.forEach(this.insert):d("error",{reason:"bulkInsert expects an array, '"+typeof a+"' was given instead."}),this},find:function(a,b){if(i=h,b=b||{},!a||null===a||null!==a&&"object"==typeof a&&0===f(a))return i=l(h,b),this;var c=i;return i=[],c.forEach(function(b){for(var c in a)void 0===b[c]||void 0!==a[c]&&!e(a[c],b[c])||i.push(b)}),i=l(i,b),this},update:function(b){if(b&&"object"==typeof b){var e=0;return i.forEach(function(a,c){for(var d in b)"_id"!=d&&(a[d]=b[d]);h[c]=i[c]=a,e++}),c(),d("updated",{collection:a,change:b,appliedTo:e}),this}},remove:function(){var b=0;return h.forEach(function(a,c){i.forEach(function(d){d._id==a._id&&(h.splice(c,1),b++,g.total--)})}),q[a]=g,j(),c(!0),d("removed",{collection:a,removed:b}),this},findById:function(a){return this.find({_id:a},{limit:1})},findOne:function(a){return this.find(a,{limit:1})},each:function(a){for(var b in i)a(i[b]);return this},filter:function(a){var b=i;return i=[],b.forEach(function(b){a(b)===!0&&i.push(b)}),this},first:function(a){return a&&"function"==typeof a?(a.call(null,[i[0]]),this):[i[0]]},last:function(a){return a&&"function"==typeof a?(a.call(null,[i[i.length-1]]),this):[i[i.length-1]]},sort:function(a){return i=k(i,a),this},skip:function(a){return i=i.slice(a),this},limit:function(a){return i=i.slice(0,a),this},count:function(a){return a&&"function"==typeof a?(a.call(null,f(i)),this):f(i)},then:function(a){return a&&"function"==typeof a?(a.call(this,i),this):this},get:function(a){return a&&"function"==typeof a?(a.call(null,i),this):i}};return m.where=m.find,m}function o(a){s=a,w=function(a){return JSON.parse(s.getItem(a))},x=function(a,b){return s.setItem(a,JSON.stringify(b)),b},y=function(a){s.removeItem(a)},p()}function p(){m(void 0===s.getItem(b("Meta"))?x(b("Meta"),{}):w(b("Meta")))}var q={},r=[],s=null,t="/",u={SORT:{ASC:1,DSC:-1},create:h,drop:i,on:c},v=function(a){return a=a||{},u};Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c,d;if(null===this)throw new TypeError(" this is null or not defined");var e=Object(this),f=e.length>>>0;if("function"!=typeof a)throw new TypeError(a+" is not a function");for(arguments.length>1&&(c=b),d=0;f>d;){var g;d in e&&(g=e[d],a.call(c,g,d,e)),d++}}),Array.prototype.containsArray=function(a){var b=null,c=null;return arguments[1]?(b=arguments[1],c=arguments[2]):(b=0,c=0,this.sort(),a.sort()),b==a.length||(c=this.indexOf(a[b],c))>-1&&this.containsArray(a,++b,++c)};var w,x,y=null;if("object"==typeof module&&module&&"object"==typeof module.exports){t="-";var z=require("node-persist");z.initSync({dir:process.env.PWD+"/ChotaData",stringify:function(a){return a},parse:function(a){return a}}),o(z),module.exports=v,z=null}else a.chrome&&chrome.runtime&&chrome.runtime.id?o():a.localStorage&&(o(a.localStorage),a.ChotaDB=v,"function"==typeof define&&define.amd&&define("ChotaDB",[],function(){return v}))}(this);